<?xml version="1.0" encoding="UTF-8"?>
<launch>
	<!-- ======================================================= arguments ==================================================== -->
	<!-- ==================================== gazebo worlds -->
<!-- 	<arg name="world_model" default="$(find dynamic_robot_localization_tests)/worlds/ship_interior.world" /> -->
<!-- 	<arg name="world_model" default="$(find dynamic_robot_localization_tests)/worlds/ship_interior_with_unstable_ground.world" /> -->
<!-- 	<arg name="world_model" default="$(find dynamic_robot_localization_tests)/worlds/ship_interior_with_cluttered_environment.world" /> -->
	<arg name="world_model" default="$(find dynamic_robot_localization_tests)/worlds/ship_interior_with_cluttered_environment_dynamic.world" />

	<!-- ==================================== 2d maps -->
	<arg name="map_file" default="$(find dynamic_robot_localization_tests)/maps/ship_interior/planar/ship_interior.yaml" />
	<!-- <arg name="map_file" default="$(find dynamic_robot_localization_tests)/maps/ship_interior/planar/ship_interior_10mm.yaml" /> -->
	<!-- <arg name="map_file" default="$(find dynamic_robot_localization_tests)/maps/ship_interior/planar/ship_interior_dynamic_10cm_height.yaml" /> -->

	<!-- ==================================== rviz configs -->
	<arg name="rviz_config" default="-d $(find dynamic_robot_localization_tests)/rviz/dynamic_robot_localization_planar.rviz" />
<!-- 	<arg name="rviz_config" default="-d $(find dynamic_robot_localization_tests)/rviz/dynamic_robot_localization_tridimensional.rviz" /> -->

<!-- ==================================== movement paths -->
	<arg name="move_robot_on_path" default="1" />
	<arg name="move_car_on_path" default="1" />
	<arg name="robot_path" default="$(find dynamic_robot_localization_tests)/maps/ship_interior/path.yaml" />	
<!-- 	<arg name="robot_path" default="$(find dynamic_robot_localization_tests)/maps/ship_interior/path_for_unstable_ground.yaml" /> -->

	<arg name="robot_initial_x" default="-4.5" />
	<arg name="robot_initial_y" default="2.25" />
	<arg name="robot_initial_z" default="0.004665" />
	<arg name="robot_initial_yaw" default="-1.57" />
	<arg name="use_tilt_on_front_laser" default="0" />
	<arg name="laser_scan" default="/tilt_scan" />
	<arg name="relay_back_laser_to_front_laser" default="1" />
	<arg name="dynamic_map_update_map" default="0" />
	<arg name="number_of_scans_to_assemble_per_cloud" default="2" />
	<arg name="timeout_for_cloud_assembly" default="1.0" />	
	<arg name="reference_pointcloud_filename" default="$(find dynamic_robot_localization_tests)/maps/ship_interior/tridimensional/cache/ship_interior_preprocessed_50mm.pcd" />
	<arg name="reference_pointcloud_keypoints_filename" default="$(find dynamic_robot_localization_tests)/maps/ship_interior/tridimensional/cache/ship_interior_iss3d_keypoints_50mm.pcd" />
	<arg name="reference_pointcloud_descriptors_filename" default="$(find dynamic_robot_localization_tests)/maps/ship_interior/tridimensional/cache/ship_interior_shot_descriptors_50mm.pcd" />
	<arg name="show_rviz" default="1" />
	<arg name="show_plots" default="1" />
	<arg name="use_odometry" default="0" />
	<arg name="use_dynamic_robot_localization" default="1" />
	<arg name="use_amcl" default="0" />
	<arg name="use_amcl_simulated" default="0" />
	<arg name="use_ekf" default="0" />


	<!-- ==================================================== gazebo simulator ================================================ -->
	<include file="$(find guardian_gazebo)/launch/guardian.launch">
		<arg name="world_model" default="$(arg world_model)" />
		<arg name="rviz_config" default="$(arg rviz_config)" />
		<arg name="use_tilt_on_front_laser" default="$(arg use_tilt_on_front_laser)" />
		<arg name="robot_initial_x" default="$(arg robot_initial_x)" />
		<arg name="robot_initial_y" default="$(arg robot_initial_y)" />
		<arg name="robot_initial_yaw" default="$(arg robot_initial_yaw)" />
	</include>

	<group if="$(arg show_rviz)">
		<node name="rviz" pkg="rviz" type="rviz" args="$(arg rviz_config)" />
	</group>


	<group if="$(arg move_car_on_path)">
		<node pkg="rostopic" type="rostopic" name="move_polaris_robot" output="screen" args="pub -1 /gazebo/set_model_state gazebo_msgs/ModelState '{model_name: polaris_ranger_ev, pose: { position: { x: 
			-2, y: -2 ,z: 0.00031 }, orientation: {x: 0.0, y: 0.0, z: 0.707, w: 0.707 } }, twist: { linear: {x: 0.0 , y: 0.208 ,z: 0 } , angular: { x: 0.0 , y: 0 , z: 0.0 } } , reference_frame: world }'"/>
		<!-- <node pkg="rosservice" type="rosservice" name="move_polaris_robot" output="screen" args="call /gazebo/set_model_state '{model_state: { model_name: polaris_ranger_ev, pose: { position: { x: -2.00007, 
			y: -1.99982 ,z: 0.000309 }, orientation: {x: 0.0, y: 0.0, z: 0.707, w: 0.707 } }, twist: { linear: {x: 0.0 , y: 0.2 ,z: 0 } , angular: { x: 0.0 , y: 0 , z: 0.0 } } , reference_frame: world } }'"/> -->
	</group>

	<!-- ======================================================== 2D costmap ================================================== -->		
	<node name="map_server" pkg="map_server" type="map_server" args="$(arg map_file)">
		<param name="frame_id" value="map" />
	</node>



	<!-- ================================================ merge two LaserScan topics ========================================== -->
	<group if="$(arg relay_back_laser_to_front_laser)">
		<node pkg="topic_tools" type="relay" name="relay_base_scan_to_tilt_scan" args="base_scan tilt_scan" output="screen" />
	</group>



	<!-- ==================================================== localization system ============================================= -->
	<group if="$(arg use_dynamic_robot_localization)">
		<include file="$(find dynamic_robot_localization_tests)/launch/localization_systems/dynamic_robot_localization.launch">
			<arg name="robot_initial_x" default="$(arg robot_initial_x)" />
			<arg name="robot_initial_y" default="$(arg robot_initial_y)" />
			<arg name="robot_initial_z" default="$(arg robot_initial_z)" />
			<arg name="robot_initial_yaw" default="$(arg robot_initial_yaw)" />
			<arg name="laser_scan" default="$(arg laser_scan)" />
			<arg name="dynamic_map_update_map" default="$(arg dynamic_map_update_map)" />
			<arg name="number_of_scans_to_assemble_per_cloud" default="$(arg number_of_scans_to_assemble_per_cloud)" />
			<arg name="timeout_for_cloud_assembly" default="$(arg timeout_for_cloud_assembly)" />
			<!-- <arg name="reference_pointcloud_filename" default="$(arg reference_pointcloud_filename)" /> -->
			<!-- <arg name="reference_pointcloud_keypoints_filename" default="$(arg reference_pointcloud_keypoints_filename)" /> -->
			<!-- <arg name="reference_pointcloud_descriptors_filename" default="$(arg reference_pointcloud_descriptors_filename)" /> -->
		</include>
	</group>



	<!-- ================================================= other localization systems ========================================== -->
	<group if="$(arg use_odometry)">
	<!-- <node pkg="tf" type="static_transform_publisher" name="map_to_odom" args="$(arg robot_initial_x) $(arg robot_initial_y) $(arg robot_initial_z) $(arg robot_initial_yaw) 0 0 map odom 10" /> -->
	
		<!-- map to odom publisher -->
		<include file="$(find dynamic_robot_localization)/launch/pose_to_tf_publisher.launch">
			<arg name="initial_x" default="$(arg robot_initial_x)" />
			<arg name="initial_y" default="$(arg robot_initial_y)" />
			<arg name="initial_z" default="$(arg robot_initial_z)" />
			<arg name="initial_yaw" default="$(arg robot_initial_yaw)" />
		</include>
	</group>

	<group if="$(arg use_amcl_simulated)">
		<!-- simulated localization -->
		<include file="$(find dynamic_robot_localization_tests)/launch/localization_systems/amcl_simulated.launch" />
	</group>

	<group if="$(arg use_amcl)">
		<!-- amcl localization -->
		<include file="$(find dynamic_robot_localization_tests)/launch/localization_systems/amcl.launch">
			<arg name="robot_initial_x" default="$(arg robot_initial_x)" />
			<arg name="robot_initial_y" default="$(arg robot_initial_y)" />
			<arg name="robot_initial_yaw" default="$(arg robot_initial_yaw)" />
			<arg name="laser_scan" default="$(arg laser_scan)" />
		</include>
	</group>


	<group if="$(arg use_ekf)">
		<!-- EFK Filter -->
		<include file="$(find dynamic_robot_localization_tests)/launch/localization_systems/ekf.launch" />
	</group>


	<!-- ===================================================== localization plots ============================================== -->
	<group if="$(arg show_plots)">
		<include file="$(find dynamic_robot_localization_tests)/launch/localization_plots.launch">
			<arg name="move_robot_on_path" default="$(arg move_robot_on_path)" />
			<arg name="robot_path" default="$(arg robot_path)" />
		</include>
	</group>



	<!-- ===================================================== navigation systems ============================================== -->
	<!-- <include file="$(find dynamic_robot_localization_tests)/launch/navigation_systems/linear_navigation.launch" /> -->
	<!-- <include file="$(find guardian_navigation)/launch/move_base.launch" /> -->
	<!-- <include file="$(find guardian_navigation)/navigation_local/move_base_local.launch" /> -->
</launch>
